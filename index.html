<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NoveClinic FINAL V9</title>
<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
header{background:#0b5ed7;color:#fff;padding:12px;text-align:center}
nav{display:flex;gap:6px;padding:8px;background:#e9ecef;flex-wrap:wrap}
nav button{padding:8px 12px;border:none;border-radius:6px;background:#0b5ed7;color:#fff;cursor:pointer}
nav .secondary{background:#6c757d}
section{display:none;padding:10px}
section.active{display:block}
.card{background:#fff;border-radius:8px;padding:10px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.15)}
.field{margin-bottom:10px}
.field label{font-weight:bold;display:block}
.field input,.field select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
.actions{display:flex;gap:6px}
.actions button{flex:1;padding:8px;border:none;border-radius:6px}
.send{background:#25d366;color:#fff}
.clear{background:#dc3545;color:#fff}
.save{background:#0b5ed7;color:#fff}
</style>
</head>

<body>

<header>NoveClinic – Sistema Escalable</header>

<nav id="mainNav"></nav>

<section id="config">
<div class="card">
<h3>⚙️ Configuración</h3>

<h4>➕ Crear ventana</h4>
<input id="newWinName" placeholder="Nombre">
<button class="save" onclick="createWindow()">Crear</button>

<hr>

<h4>✏️ Renombrar ventanas</h4>
<div id="renameManager"></div>

<hr>

<h4>➕ Campo fijo</h4>
<input id="ff_name" placeholder="Nombre campo">
<select id="ff_type">
<option value="text">Texto</option>
<option value="number">Número</option>
</select>
<div id="ff_windows"></div>
<button class="save" onclick="addFixedField()">Guardar campo</button>
</div>
</section>

<div id="preview" style="display:none" class="card">
<textarea id="previewTxt"></textarea>
<button onclick="sendWA()">Enviar</button>
</div>

<script>
/* ===== STORAGE ===== */
function get(k){return JSON.parse(localStorage.getItem(k)||"{}")}
function set(k,v){localStorage.setItem(k,JSON.stringify(v))}

let structure = get("structure");
if(!structure.windows){
 structure={
  windows:{
   base:{name:"Ventana Base",fixedFields:[]}
  }
 };
 set("structure",structure);
}

/* ===== INIT ===== */
function init(){
 document.getElementById("mainNav").innerHTML="";
 Object.entries(structure.windows).forEach(([id,w])=>{
  createSection(id,w.name,false);
 });
 addConfigBtn();
 renderRename();
}
init();

/* ===== UI ===== */
function addConfigBtn(){
 const b=document.createElement("button");
 b.textContent="⚙️ Configuración";
 b.className="secondary";
 b.onclick=()=>openWin("config");
 mainNav.appendChild(b);
}
function openWin(id){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

/* ===== WINDOWS ===== */
function createWindow(){
 const n=newWinName.value.trim();
 if(!n) return;
 const id="win_"+Date.now();
 structure.windows[id]={name:n,fixedFields:[]};
 set("structure",structure);
 createSection(id,n,true);
 newWinName.value="";
 renderRename();
}
function createSection(id,name,open){
 const b=document.createElement("button");
 b.textContent=name;
 b.onclick=()=>openWin(id);
 mainNav.appendChild(b);

 const s=document.createElement("section");
 s.id=id;
 s.innerHTML=`<div class="card"><h3>${name}</h3><div id="fixed_${id}"></div></div>`;
 document.body.insertBefore(s,document.getElementById("config"));

 renderFixedFields(id);
 if(open) openWin(id);
}

/* ===== FIXED FIELDS ===== */
function renderFixedFields(win){
 const cont=document.getElementById("fixed_"+win);
 cont.innerHTML="";
 structure.windows[win].fixedFields.forEach(f=>{
  const d=document.createElement("div");
  d.className="field";
  d.innerHTML=`<label>${f.name}</label><input type="${f.type}">`;
  cont.appendChild(d);
 });
}
function addFixedField(){
 const name=ff_name.value;
 if(!name) return;
 document.querySelectorAll("#ff_windows input:checked").forEach(ch=>{
  structure.windows[ch.value].fixedFields.push({name:name,type:ff_type.value});
  renderFixedFields(ch.value);
 });
 set("structure",structure);
 ff_name.value="";
}

/* ===== RENAME ===== */
function renderRename(){
 const c=document.getElementById("renameManager");
 c.innerHTML="";
 Object.entries(structure.windows).forEach(([id,w])=>{
  if(id==="base") return;
  c.innerHTML+=`
   <div class="field">
    <input value="${w.name}" onchange="renameWin('${id}',this.value)">
   </div>`;
 });
}
function renameWin(id,val){
 structure.windows[id].name=val;
 set("structure",structure);
 init();
}

/* ===== FIELD WINDOW SELECT ===== */
function renderFFWindows(){
 ff_windows.innerHTML="";
 Object.keys(structure.windows).forEach(id=>{
  ff_windows.innerHTML+=`
   <label><input type="checkbox" value="${id}"> ${structure.windows[id].name}</label><br>`;
 });
}
renderFFWindows();
</script>

</body>
</html>
