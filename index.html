<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NoveClinic â€“ Sistema Base Definitivo</title>

<style>
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f4f6f8}
header{background:#0b5ed7;color:#fff;padding:12px;text-align:center;font-size:18px}
nav{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:#e9ecef}
nav button{padding:8px 12px;border:none;border-radius:6px;background:#0b5ed7;color:#fff;cursor:pointer}
nav button.secondary{background:#6c757d}
section{display:none;padding:10px}
section.active{display:block}
.card{background:#fff;border-radius:8px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.15)}
.field{margin-bottom:10px}
.field label{font-weight:bold;display:block;margin-bottom:4px}
.field input,.field select,.field textarea{
 width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:15px
}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.actions button{flex:1;padding:10px;border:none;border-radius:6px;font-size:15px;cursor:pointer}
.send{background:#25d366;color:#fff}
.clear{background:#dc3545;color:#fff}
.save{background:#0b5ed7;color:#fff}
.hidden{display:none}
</style>
</head>

<body>

<header>NoveClinic â€“ Registro Inteligente Escalable</header>

<nav id="mainNav"></nav>

<!-- ================= CONFIG ================= -->
<section id="config">
<div class="card">
<h3>âš™ï¸ ConfiguraciÃ³n</h3>

<h4>â• Crear ventana</h4>
<input id="newWinName" placeholder="Nombre de la ventana">
<button class="save" onclick="createWindow()">Crear ventana</button>

<hr>

<h4>âœï¸ Renombrar ventanas</h4>
<div id="renameManager"></div>

<hr>

<h4>ğŸ—‘ï¸ Eliminar ventanas</h4>
<div id="windowManager"></div>

<hr>

<h4>â• Crear campo fijo</h4>
<input id="ff_name" placeholder="Nombre del campo">
<select id="ff_type">
<option value="text">Texto</option>
<option value="number">NÃºmero</option>
</select>
<div id="ff_windows"></div>
<button class="save" onclick="addFixedField()">Guardar campo fijo</button>

<hr>

<h4>â• Crear etiqueta dinÃ¡mica</h4>
<input id="lbl_name" placeholder="Nombre etiqueta">
<select id="lbl_type">
<option value="text">Texto</option>
<option value="number">NÃºmero</option>
<option value="select">Desplegable</option>
</select>
<input id="lbl_values" placeholder="Valores (coma separados)">
<div id="label_windows"></div>
<button class="save" onclick="addLabel()">Guardar etiqueta</button>

<hr>

<h4>ğŸ› ï¸ Administrar etiquetas</h4>
<div id="labelManager"></div>

</div>
</section>

<!-- ================= PREVIEW ================= -->
<div id="preview" class="card hidden">
<textarea id="previewTxt" rows="8"></textarea>
<div class="actions">
<button class="send" onclick="sendWA()">Enviar WhatsApp</button>
<button onclick="closePreview()">Cerrar</button>
</div>
</div>

<script>
/* ================= STORAGE ================= */
function get(k){return JSON.parse(localStorage.getItem(k)||"{}")}
function set(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* ================= STRUCTURE ================= */
let structure = get("structure");
if(!structure.windows){
 structure={
  windows:{
   base:{name:"Ventana Base",fixedFields:[]}
  },
  labels:{}
 };
 set("structure",structure);
}

/* ================= INIT ================= */
function init(){
 mainNav.innerHTML="";
 document.querySelectorAll("section:not(#config)").forEach(s=>s.remove());

 Object.entries(structure.windows).forEach(([id,w])=>{
  createSection(id,w.name);
 });

 addConfigBtn();
 renderRename();
 renderWindowManager();
 renderFFWindows();
 renderLabelWindows();
 renderLabels();
}
init();

/* ================= NAV ================= */
function addConfigBtn(){
 const b=document.createElement("button");
 b.textContent="âš™ï¸ ConfiguraciÃ³n";
 b.className="secondary";
 b.onclick=()=>openWin("config");
 mainNav.appendChild(b);
}
function openWin(id){
 document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

/* ================= WINDOWS ================= */
function createWindow(){
 const n=newWinName.value.trim();
 if(!n) return alert("Nombre requerido");
 const id="win_"+Date.now();
 structure.windows[id]={name:n,fixedFields:[]};
 set("structure",structure);
 init();
 openWin(id);
 newWinName.value="";
}
function createSection(id,name){
 const b=document.createElement("button");
 b.textContent=name;
 b.onclick=()=>openWin(id);
 mainNav.appendChild(b);

 const s=document.createElement("section");
 s.id=id;
 s.innerHTML=`
  <div class="card">
   <h3>${name}</h3>
   <div id="fixed_${id}"></div>
   <div id="custom_${id}"></div>
   <div class="actions">
    <button class="send" onclick="previewWA('${id}')">ğŸ“¤ WhatsApp</button>
    <button class="clear" onclick="clearForm('${id}')">ğŸ§¹ Limpiar</button>
   </div>
  </div>`;
 document.body.insertBefore(s,document.getElementById("config"));
 renderFixedFields(id);
}

/* ================= FIXED FIELDS ================= */
function renderFixedFields(win){
 const c=document.getElementById("fixed_"+win);
 c.innerHTML="";
 structure.windows[win].fixedFields.forEach(f=>{
  const d=document.createElement("div");
  d.className="field";
  d.innerHTML=`<label>${f.name}</label><input type="${f.type}">`;
  c.appendChild(d);
 });
}
function addFixedField(){
 const name=ff_name.value.trim();
 if(!name) return;
 document.querySelectorAll("#ff_windows input:checked").forEach(ch=>{
  structure.windows[ch.value].fixedFields.push({name:name,type:ff_type.value});
 });
 set("structure",structure);
 ff_name.value="";
 init();
}

/* ================= LABELS ================= */
function addLabel(){
 const id="lbl_"+Date.now();
 const windows={};
 document.querySelectorAll("#label_windows input").forEach(c=>windows[c.value]=c.checked);

 structure.labels[id]={
  name:lbl_name.value,
  type:lbl_type.value,
  values:lbl_values.value.split(",").map(v=>v.trim()).filter(v=>v),
  windows:windows
 };
 set("structure",structure);
 lbl_name.value=""; lbl_values.value="";
 renderLabels();
 renderLabelManager();
}
function renderLabels(){
 Object.keys(structure.windows).forEach(win=>{
  const cont=document.getElementById("custom_"+win);
  cont.innerHTML="";
  Object.values(structure.labels).forEach(l=>{
   if(l.windows[win]){
    const d=document.createElement("div");
    d.className="field";
    d.innerHTML=`<label>${l.name}</label>`;
    let el;
    if(l.type==="select"){
     el=document.createElement("select");
     l.values.forEach(v=>el.add(new Option(v,v)));
    }else{
     el=document.createElement("input");
     if(l.type==="number") el.inputMode="numeric";
    }
    d.appendChild(el);
    cont.appendChild(d);
   }
  });
 });
}

/* ================= MANAGERS ================= */
function renderRename(){
 renameManager.innerHTML="";
 Object.entries(structure.windows).forEach(([id,w])=>{
  if(id==="base") return;
  renameManager.innerHTML+=`
   <input value="${w.name}" onchange="renameWin('${id}',this.value)">`;
 });
}
function renameWin(id,v){
 structure.windows[id].name=v;
 set("structure",structure);
 init();
}
function renderWindowManager(){
 windowManager.innerHTML="";
 Object.keys(structure.windows).forEach(id=>{
  if(id==="base") return;
  windowManager.innerHTML+=`
   <button class="clear" onclick="deleteWin('${id}')">Eliminar ${structure.windows[id].name}</button><br>`;
 });
}
function deleteWin(id){
 if(!confirm("Â¿Eliminar esta ventana?")) return;
 delete structure.windows[id];
 set("structure",structure);
 init();
 openWin("base");
}
function renderFFWindows(){
 ff_windows.innerHTML="";
 Object.keys(structure.windows).forEach(id=>{
  ff_windows.innerHTML+=`
   <label><input type="checkbox" value="${id}"> ${structure.windows[id].name}</label><br>`;
 });
}
function renderLabelWindows(){
 label_windows.innerHTML="";
 Object.keys(structure.windows).forEach(id=>{
  label_windows.innerHTML+=`
   <label><input type="checkbox" value="${id}" checked> ${structure.windows[id].name}</label><br>`;
 });
}
function renderLabelManager(){
 labelManager.innerHTML="";
 Object.entries(structure.labels).forEach(([id,l])=>{
  labelManager.innerHTML+=`
   <input value="${l.name}" onchange="structure.labels['${id}'].name=this.value;set('structure',structure);renderLabels()">
   <button onclick="duplicateLabel('${id}')">ğŸ“‘</button>
   <button onclick="deleteLabel('${id}')">ğŸ—‘ï¸</button><br>`;
 });
}
function duplicateLabel(id){
 const n="lbl_"+Date.now();
 structure.labels[n]=JSON.parse(JSON.stringify(structure.labels[id]));
 structure.labels[n].name+=" (copia)";
 set("structure",structure);
 renderLabelManager();
}
function deleteLabel(id){
 delete structure.labels[id];
 set("structure",structure);
 renderLabels(); renderLabelManager();
}

/* ================= WHATSAPP ================= */
function previewWA(win){
 let t="";
 document.querySelectorAll(`#${win} input,#${win} select`).forEach(e=>{
  if(e.value) t+=e.previousSibling.textContent+": "+e.value+"\n";
 });
 previewTxt.value=t;
 preview.classList.remove("hidden");
}
function sendWA(){
 window.open("https://wa.me/?text="+encodeURIComponent(previewTxt.value));
}
function closePreview(){preview.classList.add("hidden")}
function clearForm(win){
 document.querySelectorAll(`#${win} input`).forEach(i=>i.value="");
}
</script>

</body>
</html>
